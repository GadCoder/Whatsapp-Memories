services:
  redis:
    image: "redis:alpine"
    container_name: whatsapp-memories-redis
    # Ports removed - internal communication only for Dokploy compatibility
    volumes:
      - redis-data:/data
    networks:
      - whatsapp-memories-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  postgres:
    image: pgvector/pgvector:pg16
    container_name: whatsapp-memories-postgres
    # Ports removed - internal communication only for Dokploy compatibility
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-memories}
      - POSTGRES_USER=${POSTGRES_USER:-memories}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-memories}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - whatsapp-memories-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-memories} -d ${POSTGRES_DB:-memories}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  whatsapp-collector:
    build:
      context: ./services/whatsapp-collector
      dockerfile: Dockerfile
    container_name: whatsapp-collector
    depends_on:
      redis:
        condition: service_healthy
    environment:
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      
      # Puppeteer Configuration
      - PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
      
      # Filter Configuration
      - FILTER_MODE=all                    # Options: all, allowlist, blocklist
      # - FILTER_CONTACTS=1234567890@c.us,0987654321@c.us  # Comma-separated WhatsApp IDs
      - FILTER_STRICT_VALIDATION=false     # Fail fast on invalid FILTER_CONTACTS values
      - FILTER_GROUPS=include              # Options: include, exclude, only
      - FILTER_BROADCAST=false             # Include broadcast messages?
      - MESSAGE_DEDUPE_WINDOW_MS=600000    # Suppress duplicate message IDs for 10 minutes
      
      # Retry Configuration
      - RETRY_MAX_ATTEMPTS=3
      - RETRY_INITIAL_DELAY=1000           # milliseconds
      - RETRY_MAX_DELAY=10000              # milliseconds
      - RETRY_BACKOFF_MULTIPLIER=2
      
      # Queue Configuration
      - QUEUE_MAX_SIZE=1000                # Max messages to queue locally
      - QUEUE_FLUSH_INTERVAL=60000         # milliseconds (1 minute)
      - QUEUE_DEAD_LETTER_PATH=/usr/src/app/data/publisher-dead-letter.ndjson
      
      # Debug
      - DEBUG=true                         # Enable debug logging (set to false in production)
    volumes:
      # Persist WhatsApp authentication session using named volume
      # Named volume survives git clones and container rebuilds (unlike bind mount)
      - wwebjs-auth:/usr/src/app/.wwebjs_auth
    networks:
      - whatsapp-memories-network
    restart: on-failure:5                  # Restart max 5 times on failure

  message-storage:
    build:
      context: ./services/message-storage
      dockerfile: Dockerfile
    container_name: message-storage
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      
      # PostgreSQL Configuration
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-memories}
      - POSTGRES_USER=${POSTGRES_USER:-memories}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-memories}
      
      # Embedding Provider Configuration
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-openai}
      - EMBEDDING_FALLBACK_PROVIDER=${EMBEDDING_FALLBACK_PROVIDER:-}
      - EMBEDDINGS_REQUIRED=${EMBEDDINGS_REQUIRED:-false}   # true = fail startup if embeddings unavailable
      
      # OpenAI Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      
      # Google Gemini Configuration (optional)
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GEMINI_EMBEDDING_MODEL=${GEMINI_EMBEDDING_MODEL:-text-embedding-004}
      
      # Encryption Configuration
      # Generate key with: openssl rand -hex 32
      # CRITICAL: Keep this key secure - without it, encrypted data is unrecoverable
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # Debug
      - DEBUG=${DEBUG:-false}
    networks:
      - whatsapp-memories-network
    restart: unless-stopped

  embedding-api:
    build:
      context: ./services/embedding-api
      dockerfile: Dockerfile
    container_name: embedding-api
    # INTERNAL ACCESS ONLY - No port exposed to host
    # OpenClaw accesses via Docker network
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Server
      - PORT=3002
      
      # PostgreSQL Configuration
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=${POSTGRES_DB:-memories}
      - POSTGRES_USER=${POSTGRES_USER:-memories}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-memories}
      - PG_POOL_SIZE=10
      
      # OpenAI Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_EMBEDDING_MODEL=${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      
      # Encryption Configuration
      # Must match the key used by message-storage
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}
      
      # Auth - REQUIRED: No default, service fails to start if not set
      - API_TOKEN=${API_TOKEN}
      
      # Rate Limiting
      - RATE_LIMIT_REQUESTS_PER_MINUTE=60
      
      # Logging
      - LOG_LEVEL=info
    networks:
      - whatsapp-memories-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  redis-data:
  postgres-data:
  wwebjs-auth:  # Named volume for WhatsApp session persistence

networks:
  whatsapp-memories-network:
    driver: bridge
